package com.example.uploadproxy.controller;

import com.example.uploadproxy.dto.UploadResponse;
import com.example.uploadproxy.service.AuthTokenService;
import com.example.uploadproxy.service.ExternalUploadService;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/files")
public class FileUploadController {

  private final ExternalUploadService externalUploadService;
  private final AuthTokenService authTokenService;

  // Optional for /upload-xlsx-with-login
  @Value("${auth.client-id:}")
  private String clientId;
  @Value("${auth.client-secret:}")
  private String clientSecret;
  @Value("${auth.username:}")
  private String username;
  @Value("${auth.password:}")
  private String password;

  public FileUploadController(ExternalUploadService externalUploadService, AuthTokenService authTokenService) {
    this.externalUploadService = externalUploadService;
    this.authTokenService = authTokenService;
  }

  // Client provides Authorization header to YOUR controller
  @PostMapping("/upload-xlsx")
  public ResponseEntity<UploadResponse> uploadXlsx(
      @RequestPart("file") MultipartFile file,
      @RequestHeader("Authorization") String authorization
  ) throws Exception {

    String token = authorization.replaceFirst("(?i)^bearer\\s+", "").trim();
    byte[] bytes = file.getBytes();

    UploadResponse resp = externalUploadService.uploadXlsxBytes(bytes, token);
    return ResponseEntity.ok(resp);
  }

  // Server fetches token using configured creds, then uploads
  @PostMapping("/upload-xlsx-with-login")
  public ResponseEntity<UploadResponse> uploadXlsxWithLogin(
      @RequestPart("file") MultipartFile file
  ) throws Exception {

    var tokenResp = authTokenService.passwordGrant(clientId, clientSecret, username, password);
    byte[] bytes = file.getBytes();

    UploadResponse resp = externalUploadService.uploadXlsxBytes(bytes, tokenResp.accessToken);
    return ResponseEntity.ok(resp);
  }
}
